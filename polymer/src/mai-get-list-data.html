<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="mai-get-list-data">

    <template>
        <app-localstorage-document key="token" data="{{tokenData}}" storage="window.localStorage"></app-localstorage-document>

        <iron-ajax
                id="getList"
                method="[[method]]"
                headers$='{"FM-data-token": "[[tokenData.token]]"}'
                handle-as="json"
                on-response="listLoaded"
        ></iron-ajax>

        <iron-ajax
                id="getRecordCount"
                method="[[method]]"
                url="[[_computeURLforRecordCount()]]"
                headers$='{"FM-data-token": "[[tokenData.token]]"}'
                handle-as="json"
                on-response="getRecordCount"
        ></iron-ajax>

        <iron-ajax
                id="addNew"
                method="POST"
                url="[[_computeURLforNewRecord()]]"
                headers$='{"FM-data-token": "[[tokenData.token]]"}'
                handle-as="json"
                on-response="getNewRecordId"
        ></iron-ajax>
    </template>

    <script>
        (function() {
            class MaiGetListData extends Polymer.Element {
                static get is() {
                    return 'mai-get-list-data';
                }

                static get properties() {
                    return {
                        listData: {
                            type: Array,
                            notify: true,
                        },
                        layoutName:{
                            type: String
                        },
                        selectedItem: {
                            type: Object,
                            notify: true
                        },
                        method: {
                            type: String,
                            notify: true
                        },
                        filterQuery:{
                            type:String,
                            notify:true
                        },
                        pageSize:{value:20},
                        totalRecord: Number,
                        pages: {type: Array, notify: true},
                        currentPage:{type:Number, value:0, notify:true},
                        addNew:{type:Boolean, notify:true,
                                observer:'_addNewChanged'}
                    }
                }

                static get observers() {
                    return [
                        '_currentPageChanged(currentPage,filterQuery,tokenData)'
                    ]
                }

                _addNewChanged(addNew, oldAddNew){

                    if(addNew && !(addNew===oldAddNew)){
                        this.$.addNew.generateRequest();
                        this.addNew = false;
                    }
                }

                _currentPageChanged(currentPage,filterQuery,tokenData){
                    if(tokenData && currentPage!==undefined) {
                        if(filterQuery) {
                            if (filterQuery === "none") {
                                this.method = "GET";
                            }
                            else {
                                this.method = "POST";
                                this.$.getList.body = '{"query":[{' + filterQuery + '}]}';
                                this.$.getRecordCount.body = '{"query":[{' + filterQuery + '}]}';
                            }
                        }
                        else {
                            this.method = "GET";
                        }
                        this.getData();
                    }
                }

                getData(){
                    this.$.getList.url = this._computeURL();
                    this.$.getList.headers = {'fm-data-token': this.tokenData.token};
                    this.$.getList.generateRequest();
                    //get total records as well
                    this.$.getRecordCount.headers = {'fm-data-token': this.tokenData.token};
                    this.$.getRecordCount.generateRequest();

                }

                listLoaded(data) {
                    if(data.detail.response!==null) {
                        this.listData = data.detail.response;
                        //console.log(this.layoutName);
                        //console.log('recordId' in this.selectedItem);
                        if(this.selectedItem && 'recordId' in this.selectedItem) {
                            for (var i = 0; i < this.listData.length; i++) {
                                if (this.listData[i].recordId == this.selectedItem.recordId) {
                                    this.selectedItem = this.listData[i];
                                    break;
                                }
                            }
                        }
                        else{
                            this.selectedItem = this.listData[0];
                        }
                        //console.log(this.selectedItem);
                    }
                }

                getRecordCount(data){
                    if(data.detail.response!==null){
                        this.totalRecord = data.detail.response;
                        //console.log(this.totalRecord);

                        this.pages = Array.apply( null, {length: Math.ceil(this.totalRecord/this.pageSize)} ).map((item, index) => {
                            return index + 1;
                        });
                        //console.log(this.pages);
                    }
                }

                getNewRecordId(data){
                    if(data.detail.response!==null) {
                       //console.log(data.detail.response);
                       //console.log(this.selectedItem);
                       this.selectedItem.recordId = data.detail.response.recordId;
                       /*TODO: Load newly added item to selectedItem*/

                        this.dispatchEvent(new CustomEvent('add-new-item',
                            {
                                bubbles: true,
                                composed: true,
                                detail: {
                                    name: this._getLayout(this.layoutName),
                                    recordId: data.detail.response.recordId
                                }
                            }));
                    }
                }

                _getLayout(flag){
                    var layout='';
                    switch(flag){
                        case 'claimants':
                            layout = 'L131_CLAIMANT_List_View';
                            break;
                        case 'clients':
                            layout = 'L11_ACCOUNTS_List_View';
                            break;
                        case 'contacts':
                            layout = 'L31_CONTACTS_List_View';
                            break;
                        case 'investigators':
                            layout = 'L131_INVESTIGATOR_List_View';
                            break;
                        case 'projects':
                            layout = 'L121_PROJECTS_List_View';
                            break;
                        case 'staffs':
                            layout = 'L131_STAFF_List_View';
                            break;
                        case 'tasks':
                            layout = 'L141_TIMESHEETS_List_View';
                            break;
                    }
                    return layout;
                }
                _computeURL() {

                    return `https://localhost:3000/fm/getList/${this._getLayout(this.layoutName)}/${this.currentPage}/${this.pageSize}`;
                }

                _computeURLforRecordCount(){
                    return `https://localhost:3000/fm/getRecordCount/${this._getLayout(this.layoutName)}`;
                }

                _computeURLforNewRecord(){
                    return `https://localhost:3000/fm/add/${this._getLayout(this.layoutName)}`;
                }

            }
            window.customElements.define(MaiGetListData.is, MaiGetListData);
        }());
    </script>
</dom-module>