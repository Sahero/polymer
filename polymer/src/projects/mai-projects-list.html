<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="mai-projects-list-data.html">
<link rel="import" href="../mai-page-layout.html">

<dom-module id="mai-projects-list">
    <template>

        <style include="mai-datatable-styles mai-shared-styles">

        </style>

        <mai-projects-list-data selected-item="{{selectedItem}}"
                                projects-data="{{projectsData}}"
                                filter-query="{{filterQuery}}"
                                pages="{{pages}}"
                                current-page="{{currentPage}}"
        ></mai-projects-list-data>

        <div class="filter-button">
            <iron-selector attr-for-selected="field-name" selected="none">
                <paper-button field-name="none" filter-text="none" on-tap="_onFilterClick"><iron-icon icon="filter-none"></iron-icon>Find All</paper-button>
                <paper-button field-name="Status" filter-text="open" on-tap="_onFilterClick">Find Open</paper-button>
                <paper-button field-name="Category" filter-text="surveillance" on-tap="_onFilterClick">Find Surveillance</paper-button>
                <paper-button field-name="Factual">Find Factual</paper-button>
            </iron-selector>
        </div>

        <vaadin-grid items="{{projectsData}}" id="projectsListViewDatatable" class="list-view-datatable" active-item="{{selectedItem}}">

            <vaadin-grid-column>
                <template class="header">
                    <vaadin-grid-sorter path="fieldData.ID_Project">REF #</vaadin-grid-sorter>
                </template>
                <template>[[item.fieldData.ID_Project]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">CLAIM #</template>
                <template>[[item.fieldData.Claim_No]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Claimant</template>
                <template>[[item.fieldData.Claimant]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Contact</template>
                <template>[[item.fieldData.Auditing_Assigned_Contacts_Names]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Client</template>
                <template>[[item.fieldData.Account_Name]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Staff</template>
                <template>[[item.fieldData.Auditing_Assigned_Staff_Names]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Investigators</template>
                <template>[[item.fieldData.Auditing_Assigned_Investigators_Names]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Start</template>
                <template>[[item.fieldData.Date_Start]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">End</template>
                <template>[[item.fieldData.Date_End]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Due</template>
                <template><span class$="{{_getClassForDueDate(item.fieldData.Date_Due)}}">[[item.fieldData.Date_Due]]</span></template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Category</template>
                <template>[[item.fieldData.Category]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Status</template>
                <template><span class$="{{_getClassForStatus(item.fieldData.Status)}}">[[item.fieldData.Status]]</span></template>
            </vaadin-grid-column>
        </vaadin-grid>
        <!--<div id="pages">
            <button on-tap="_prev">&lt;</button>
            <dom-repeat items="[[pages]]">
                <template>
                    <button on-tap="_select" selected$="[[_isSelected(currentPage, item)]]">[[item]]</button>
                </template>
            </dom-repeat>
            <button on-tap="_next">&gt;</button>
        </div>-->
        <mai-page-layout pages="{{pages}}" current-page="{{currentPage}}"></mai-page-layout>
    </template>


    <script>

        (function() {
            class MaiProjectsList extends Polymer.Element {
                static get is() {
                    return 'mai-projects-list';
                }

                static get properties() {
                    return {
                        projectsData: {
                            type: Array,
                            notify:true
                        },
                        selectedItem: {
                            observer: '_selectedItemChanged'
                        }

                    }
                }/*

                _isSelected(page, item) {
                    //console.log(page, item);
                return page === item - 1;
            }

                _select(e) {
                    console.log(e.model.item);
                this.currentPage = e.model.item - 1;
            }

                _next() {

                this.currentPage = Math.min(this.pages.length - 1, this.currentPage + 1);
                    console.log(this.currentPage);
            }

                _prev() {
                this.currentPage = Math.max(0, this.currentPage - 1);
                    console.log(this.currentPage);
            }*/

                _selectedItemChanged(item){

                    if(item) {
                        this.$.projectsListViewDatatable.selectedItems = item ? [item] : [];
                        // this.selectedItem = item;
                        //console.log(this.selectedItem);
                        this.dispatchEvent(new CustomEvent('project-item-selected',
                            {
                                bubbles: true,
                                composed: true,
                                detail: {
                                    data: this.selectedItem
                                }
                            }));
                    }
                }

                _getClassForStatus(status) {
                    //console.log(status);
                    if (status=="Open") {
                        return "open";
                    }
                    return "completed";
                }

                _getClassForDueDate(dueDate) {
                    if(dueDate=="" || dueDate ==null){
                        return "";
                    }

                    var today = new Date();
                    dueDate=new Date(dueDate);
                    //console.log((dueDate - today)/(1000*60*60*24));
                    if (today > dueDate) {
                        return "dueOver";
                    }
                    else if(((dueDate - today)/(1000*60*60*24)) < 5){
                        return "dueSoon";
                    }
                    else{
                        return "";
                    }

                }

                _onFilterClick(e){
                    var fieldname = e.target.getAttribute('field-name');
                    var filtertext = e.target.getAttribute('filter-text');
                    this.currentPage = 0;
                    if(fieldname === "none"){
                        this.filterQuery = "none";
                    }else{
                        this.filterQuery= '"'+fieldname+'":"'+filtertext+'"';
                    }
                }

            }

            window.customElements.define(MaiProjectsList.is, MaiProjectsList);
        }());


    </script>
</dom-module>
