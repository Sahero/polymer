<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<!--<link rel="import" href="../../bower_components/vaadin-grid/all-imports.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../mai-datatable-styles.html">-->


<dom-module id="mai-projects-list">
    <template>

        <style include="mai-datatable-styles mai-shared-styles">


        </style>

        <app-localstorage-document key="token" data="{{tokenData}}" storage="window.localStorage"></app-localstorage-document>

        <iron-ajax
                auto
                id="getProjectsList"
                method="get"
                url="[[_computeURL()]]"
                headers$='{"FM-data-token": "[[tokenData.token]]"}'
                handle-as="json"
                last-response="{{listData}}"
                on-response="listLoaded"
        ></iron-ajax>

        <div class="filter-button">
            <ul>
                <li><paper-button toggles><iron-icon icon="filter-none"></iron-icon>Find All</paper-button></li>
                <li><paper-button toggles on-tap="_onFilterClick">Find Open</paper-button></li>
                <li><paper-button toggles>Find Surveillance</paper-button></li>
                <li><paper-button toggles>Find Factual</paper-button></li>
            </ul>
        </div>

        <vaadin-grid items="{{listData}}" id="projectsListViewDatatable" class="list-view-datatable" active-item="{{selectedItem}}">

            <vaadin-grid-column>
                <template class="header">
                    <vaadin-grid-sorter path="fieldData.ID_Project">REF #</vaadin-grid-sorter>
                </template>
                <template>[[item.fieldData.ID_Project]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">CLAIM #</template>
                <template>[[item.fieldData.Claim_No]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Claimant</template>
                <template>[[item.fieldData.Claimant]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Contact</template>
                <template>[[item.fieldData.Auditing_Assigned_Contacts_Names]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Client</template>
                <template>[[item.fieldData.Account_Name]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Staff</template>
                <template>[[item.fieldData.Auditing_Assigned_Staff_Names]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Investigators</template>
                <template>[[item.fieldData.Auditing_Assigned_Investigators_Names]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Start</template>
                <template>[[item.fieldData.Date_Start]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">End</template>
                <template>[[item.fieldData.Date_End]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Due</template>
                <template><span class$="{{_getClassForDueDate(item.fieldData.Date_Due)}}">[[item.fieldData.Date_Due]]</span></template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Category</template>
                <template>[[item.fieldData.Category]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">Status</template>
                <template><span class$="{{_getClassForStatus(item.fieldData.Status)}}">[[item.fieldData.Status]]</span></template>
            </vaadin-grid-column>
        </vaadin-grid>

    </template>


    <script>

        (function() {
            class MaiProjectsList extends Polymer.Element {
                static get is() {
                    return 'mai-projects-list';
                }

                static get properties() {
                    return {
                        listData: {
                            type: Array,
                            notify:true
                        },
                        selectedItem: {
                            observer: '_selectedItemChanged'
                        }
                    }
                }

                listLoaded(data){
                    this.listData= data.detail.response;
                    console.log(this.listData);
                    if(this.listData) {
                        this.$.projectsListViewDatatable.activeItem = this.listData[0];
                    }
                    //console.log(this.listData);
                }

                _selectedItemChanged(item){
                    if(item) {
                        this.$.projectsListViewDatatable.selectedItems = item ? [item] : [];
                        // this.selectedItem = item;
                        //console.log(this.selectedItem);
                        this.dispatchEvent(new CustomEvent('project-item-selected',
                            {
                                bubbles: true,
                                composed: true,
                                detail: {
                                    data: this.selectedItem
                                }
                            }));
                    }
                }

                _getClassForStatus(status) {
                    //console.log(status);
                    if (status=="Open") {
                        return "open";
                    }
                    return "completed";
                }

                _getClassForDueDate(dueDate) {
                    if(dueDate=="" || dueDate ==null){
                        return "";
                    }

                    var today = new Date();
                    dueDate=new Date(dueDate);
                    //console.log((dueDate - today)/(1000*60*60*24));
                    if (today > dueDate) {
                        return "dueOver";
                    }
                    else if(((dueDate - today)/(1000*60*60*24)) < 5){
                        return "dueSoon";
                    }
                    else{
                        return "";
                    }

                }

                _onFilterClick(){
                    console.log('s');
                    this.$.getProjectsList.set('params',{"fieldData.Status":"Open"});
                    console.log(this.$.getProjectsList);
                    this.$.getProjectsList.generateRequest();
                }

                _computeURL(){
                    return `https://localhost:3000/fm/getList/L121_PROJECTS_List_View`;
                    //return `https://localhost:3000/fm/getLocalProjectsList`;
                }

            }

            window.customElements.define(MaiProjectsList.is, MaiProjectsList);
        }());


    </script>
</dom-module>
