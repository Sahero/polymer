<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/vaadin-grid/all-imports.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../mai-input.html">
<link rel="import" href="../mai-input-date.html">

<dom-module id="mai-projects-detail">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment mai-datatable-styles mai-detail-styles">

        </style>

        <app-localstorage-document key="token" data="{{tokenData}}" storage="window.localStorage"></app-localstorage-document>
        <!--url$="https://localhost:3000/fm/getProjectsDetail/{{recordId}}"-->
        <iron-ajax
                id="getProjectsDetail"
                method="get"
                url="[[_computeURL(recordId)]]"
                headers$='{"FM-data-token": "[[tokenData.token]]"}'
                handle-as="json"
                on-response="detailLoaded"
        ></iron-ajax>

        <iron-ajax
                id="updateProjectsDetail"
                method="put"
                url="[[_computeURL(recordId)]]"
                headers$='{"FM-data-token": "[[tokenData.token]]"}'
                handle-as="json"
                on-response="checkUpdateResult"
        ></iron-ajax>

        <div class="layout horizontal wrap around-justified">


            <!--<div class="" >-->
            <iron-list id="list" class="box-spacing" items="{{projectDetail}}" as="project" scroll-target="document">
                <template>
                    <div class="group-item border-lightgray">
                        <div class="group-header group-item-row border-bottom-lightgray">
                            <span class="primary">REF#</span>
                            <span class="secondary">[[project.fieldData.ID_Project]]</span>
                        </div>
                        <div class="group-item-row border-bottom-lightgray">
                            <span class="primary">Title</span>
                            <mai-input class="secondary" value="{{project.fieldData.Project_Name::input}}"></mai-input>
                        </div>
                        <div class="group-item-row border-bottom-lightgray">
                            <span class="primary">Category</span>
                            <span class="secondary">[[project.fieldData.Category]]</span>
                        </div>
                        <div class="group-item-row border-bottom-lightgray">
                            <span class="primary">Status</span>
                            <span class="secondary">[[project.fieldData.Status]]</span>
                        </div>
                        <div class="group-item-row border-bottom-lightgray">
                            <span class="primary">Claim No</span>
                            <span class="secondary">[[project.fieldData.Claim_No]]</span>
                        </div>
                        <div class="group-item-row border-bottom-lightgray">
                            <span class="primary">Policy No</span>
                            <span class="secondary">[[project.fieldData.Policy_No]]</span>
                        </div>
                        <div class="group-item-row border-bottom-lightgray">
                            <span class="primary">Company</span>
                            <span class="secondary">[[project.fieldData.Account_Name]]</span>
                        </div>
                        <div class="group-item-row border-bottom-lightgray">
                            <span class="primary">Claimant</span>
                            <span class="secondary">[[project.fieldData.Claimant]]</span>
                        </div>
                    </div>
                </template>
            </iron-list>
            <!--</div>-->

            <div class="group-staff box-spacing border-lightgray">
                <div class="group-header">
                    <div class="box-container">Staff</div>
                    <div class="all-list border-lightgray layout vertical">
                        <dom-repeat items="{{staffs}}" as="staff" scroll-target="document">
                            <template>
                                <ul>
                                    <li><a href="/staffs/detail/1304">[[_getDataFromArray(staffs.*, index, 'T16q_projects_STAFF|id_staff|id_staff|::Name_Full')]]</a></li>
                                    <li><paper-icon-button icon="close"></paper-icon-button></li>
                                    <li><paper-icon-button icon="search"></paper-icon-button></li>
                                    <li><paper-icon-button icon="mail"></paper-icon-button></li>
                                </ul>
                            </template>
                        </dom-repeat>

                        <ul>
                            <li></li>
                            <li><span>Add: </span><paper-icon-button icon="search"></paper-icon-button></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="group-investigators box-spacing border-lightgray">
                <div class="group-header">
                    <div class="box-container">Investigators</div>
                    <div class="all-list border-lightgray layout vertical">

                        <dom-repeat items="{{investigators}}" as="investigator" scroll-target="document">
                            <template>
                                <ul>
                                    <li><a href="/">[[investigator.PRJ_Projects_ING_Investigators::Investigator]]</a></li>
                                    <li><paper-icon-button icon="close"></paper-icon-button></li>
                                    <li><paper-icon-button icon="search"></paper-icon-button></li>
                                    <li><paper-icon-button icon="mail"></paper-icon-button></li>
                                </ul>
                            </template>
                        </dom-repeat>

                        <ul>
                            <li></li>
                            <li><span>Add: </span><paper-icon-button icon="search"></paper-icon-button></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="group-staff box-spacing border-lightgray">
                <div class="group-header">
                    <div class="box-container">Contacts</div>
                    <div class="all-list border-lightgray layout vertical">
                        <dom-repeat items="{{contacts}}" as="contact" scroll-target="document">
                            <template>
                                <ul>
                                    <li><a href="/">[[contact.PRJ_Projects_CON_Contacts::Contact]]</a></li>
                                    <li><paper-icon-button icon="close"></paper-icon-button></li>
                                    <li><paper-icon-button icon="search"></paper-icon-button></li>
                                    <li><paper-icon-button icon="mail"></paper-icon-button></li>
                                </ul>
                            </template>
                        </dom-repeat>
                        <ul>
                            <li></li>
                            <li><span>Add: </span><paper-icon-button icon="search"></paper-icon-button></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!--</div>-->

            <!--Tab-->
            <div class="group-tabs box-spacing border-lightgray" >
                <paper-tabs  class="border-bottom-lightgray " selected="{{papertabSelected}}" attrForSelected="name">
                    <paper-tab class="border-right-lightgray" link name="tasks"><span class="counts">{{tasks.length}} </span> Tasks </paper-tab>
                    <paper-tab class="border-right-lightgray" link name="files"><span class="counts">{{files.length}} </span>  Files </paper-tab>
                    <paper-tab class="border-right-lightgray" link name="notes"><span class="counts">{{notes.length}} </span>  Note </paper-tab>
                    <paper-tab link name="auditfield"> Audit Field </paper-tab>
                </paper-tabs>

                <iron-pages selected="{{papertabSelected}}" attrForSelected="name">
                    <div name="tasks">
                        <vaadin-grid items="{{tasks}}" class="list-view-datatable">
                            <vaadin-grid-column>
                                <template class="header">Summary</template>
                                <template>[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Item')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Staff</template>
                                <template>[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Staff_Name')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Investigator</template>
                                <template>[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Investigator_Name')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Contact</template>
                                <template>[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Contact_Name')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Email</template>
                                <template>[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Email_Form_Title')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Due</template>
                                <template>[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Date_Due')]]
                                    <span class="time">[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Time_Due')]]</span>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">End</template>
                                <template>[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Date_Completed')]]
                                    <span class="time">[[_getDataFromArray(tasks.*, index, 'T16s_projects_TO_DO_LIST||id_project|::Time_Completed')]]</span>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Days Remaining</template>
                                <template></template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                    <div name="files">
                        <vaadin-grid items="{{files}}" class="list-view-datatable">
                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template><paper-icon-button icon="delete"></paper-icon-button></template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template><paper-icon-button icon="info"></paper-icon-button></template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="100px" flex-grow="0">
                                <template class="header">Date</template>
                                <template>[[_getDataFromArray(files.*, index, 'T16c1_project_DOCUMENTS|thru_mtm|id_project|::Date_Created')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Staff</template>
                                <template>[[_getDataFromArray(files.*, index, 'T16c1_project_DOCUMENTS|thru_mtm|id_project|::Document_Name')]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                    <div name="notes">
                        <vaadin-grid id="notegrid" items="{{projectDetail}}" class="list-view-datatable"
                                     on-active-item-changed="_onNoteDetailsChanged">
                            <template class="row-details">
                                <div class="note-details">
                                    <h5>Text:</h5>
                                    <iron-autogrow-textarea class="iron-textarea" readonly value="[[_getDataFromArray(projectDetail.*, index, 'fieldData.T16l_projects_NOTES||id_note|::Text')]]"></iron-autogrow-textarea>
                                </div>
                            </template>

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template><paper-icon-button icon="delete"></paper-icon-button></template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="100px" flex-grow="0">
                                <template class="header">Date</template>
                                <template>[[_getDataFromArray(projectDetail.*, index, 'fieldData.T16l_projects_NOTES||id_note|::Date')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Type</template>
                                <template>[[_getDataFromArray(projectDetail.*, index, 'fieldData.T16l_projects_NOTES||id_note|::Note_Type')]]</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Recipient</template>
                                <template></template>
                            </vaadin-grid-column>
                            <vaadin-grid-column>
                                <template class="header">Subject</template>
                                <template>[[_getDataFromArray(projectDetail.*, index, 'fieldData.T16l_projects_NOTES||id_note|::Note_Subject')]]</template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                    <div name="auditfield">
                        <iron-autogrow-textarea class="iron-textarea" readonly value="[[auditField]]"></iron-autogrow-textarea>
                    </div>
                </iron-pages>
            </div>
            <iron-list class="box-spacing" items="{{projectDetail}}" as="project" scroll-target="document">
                <template>
                    <div class="group-item border-lightgray">
                        <div class="group-header">
                            <div class="box-container">Dates</div>
                            <div class="group-item border-lightgray" style="display:table">
                                <div class="group-item-row border-bottom-lightgray">
                                    <span class="primary">Start</span>
                                    <span class="secondary">
                                        <mai-input-date value="[[_changeDateFormat(project.fieldData.Date_Start)]]"></mai-input-date>
                                    </span>
                                </div>
                                <div class="group-item-row border-bottom-lightgray">
                                    <span class="primary">End</span>
                                    <span class="secondary">
                                        <mai-input-date data="{{project.fieldData.Date_End}}"></mai-input-date>
                                        <!--<iron-input bind-value="[[_changeDateFormat(project.fieldData.Date_End)]]"><input type="text" onfocus="(this.type='date')" onfocusout="(this.type='text')"></iron-input>-->
                                    </span>
                                </div>
                                <div class="group-item-row border-bottom-lightgray">
                                    <span class="primary">Injury</span>
                                    <span class="secondary">
                                        <mai-input-date value="[[_changeDateFormat(project.fieldData.Date_Injury::input)]]"></mai-input-date>
                                        <!--<iron-input bind-value="[[project.fieldData.Date_Injury]]"><input type="text" value="{{value::input}}" onfocus="(this.type='date')" onfocusout="(this.type='text')"></iron-input>-->
                                    </span>
                                </div>
                                <div class="group-item-row border-bottom-lightgray">
                                    <span class="primary">Instruction</span>
                                    <span class="secondary">
                                        <!--<mai-input-date value="[[_changeDateFormat(project.fieldData.Date_Instruction)]]"></mai-input-date>-->
                                        <!--<mai-input value="{{project.fieldData.Date_Instruction::input}}"></mai-input>-->
                                        <vaadin-date-picker value="{{_changeDateFormat(project.fieldData.Date_Instruction)}}">
                                        </vaadin-date-picker>
                                        <!--<iron-input bind-value="[[_changeDateFormat(project.fieldData.Date_Instruction)]]"><input type="text" onfocus="(this.type='date')" onfocusout="(this.type='text')"></iron-input>-->
                                    </span>
                                </div>
                                <div class="group-item-row border-bottom-lightgray">
                                    <span class="primary">Due Client</span>
                                    <span class="secondary"><iron-input bind-value="[[_changeDateFormat(project.fieldData.Date_Due)]]"><input type="text" onfocus="(this.type='date')" onfocusout="(this.type='text')"></iron-input></span>
                                </div>
                                <div class="group-item-row border-bottom-lightgray">
                                    <span class="primary">Due Invest</span>
                                    <span class="secondary"><iron-input bind-value="[[_changeDateFormat(project.fieldData.Date_Due_Investigator)]]"><input type="text" onfocus="(this.type='date')" onfocusout="(this.type='text')"></iron-input></span>
                                </div>
                            </div>
                        </div>
                    </div>

                </template>
            </iron-list>
        </div>
    </template>

    <script>
        (function() {
            class MaiProjectsDetail extends Polymer.Element {
                static get is() {
                    return 'mai-projects-detail';
                }
                static get properties() {
                    return {
                        projectDetail: Array,
                        recordId: {
                            type: String,
//                        value: '',
                            //notify:true,
                            //observer: '_recordIdChanged'
                        },
                        investigators: Array,
                        staffs:Array,
                        contacts: Array,
                        tasks: Array,
                        files: Array,
                        notes: Array,
                        auditField: String
                    };
                }

                static get observers() {
                    return [
                        '_recordIdChanged(recordId)','_onProjectDetailChanged(projectDetail.*)'
                    ]
                }

                _recordIdChanged(recordId){
                    this.$.getProjectsDetail.generateRequest();
                }

                ready(){
                    super.ready();
                    //console.log('ready');
                    //console.log(this.$.getProjectsDetail);
                }

                detailLoaded(data){
                    console.log(data.detail.response);
                    this.projectDetail= data.detail.response;
                    if(this.projectDetail){
                        this.investigators = this.projectDetail[0].portalData.Investigator_Portal;
                        this.contacts = this.projectDetail[0].portalData.portalProjectContacts;
                        this.staffs = this.projectDetail[0].portalData["Investigator_Portal Copy"];
                        this.tasks = this.projectDetail[0].portalData.tasks_portal;
                        this.files = this.projectDetail[0].portalData.portalDocuments;
                        this.auditField = this.projectDetail[0].fieldData.Audit_log_UltraLog;
                        /*
                         var tempStaff = this.projectDetail[0].portalData["Investigator_Portal Copy"];

                         //this.staffs = {recordId:'', Name_Full:''};
                         this.staffs = new Array();
                         for(var i=0; i < tempStaff.length; i++){
                         //console.log(tempStaff[i]);
                         //console.log(tempStaff[i]["T16q_projects_STAFF|id_staff|id_staff|::Name_Full"]);
                         this.staffs.push(
                         {
                         recordId : tempStaff[i].recordId,
                         Name_Full : tempStaff[i]["T16q_projects_STAFF|id_staff|id_staff|::Name_Full"]
                         }
                         );
                         //this.staffs.Name_Full = tempStaff[i]["T16q_projects_STAFF|id_staff|id_staff|::Name_Full"];
                         }*/



                        //console.log(this.notes);
                        //console.log(this._changeDateFormat('05/29/201'));

                    }

                }
                _computeURL(recordId){
                    console.log(recordId);

                    return `https://localhost:3000/fm/getDetail/L120_Projects_Data_entry/${recordId}`;
                    //return `https://localhost:3000/fm/getLocalProjectsDetail/${recordId}`;
                }

                _getDataFromArray(dataList, index, path) {
                    //console.log(dataList);
                    if(dataList.value===null){
                        return;
                    }
                    return this.get(path, dataList.base[index]);
                }

                _onNoteDetailsChanged(e) {
                    this.$.notegrid.expandedItems = [e.detail.value];
                }

                _changeDateFormat(date){
                    if(date===null || date===""){
                        return null;
                    }
                    var d = new Date(date);
                    return d.getFullYear()+'-'+('0' + (d.getMonth()+1)).slice(-2)+'-'+('0' + (d.getDate())).slice(-2);

                }


                _onProjectDetailChanged(changeDetail) {
                    //console.log(changeDetail);
                    if(changeDetail.path !=='projectDetail') {
                        var path = changeDetail.path;
                        var fieldName = path.substring(path.lastIndexOf('.') + 1);
                        var body = `"${fieldName}":"${changeDetail.value}"`;
                        console.log(body);
                        //console.log({"data":{body}});
                        this.$.updateProjectsDetail.body = body;
                        this.$.updateProjectsDetail.generateRequest();
                    }
                }

                checkUpdateResult(data){
                    console.log(data.detail.response);
                }

            }
            window.customElements.define(MaiProjectsDetail.is, MaiProjectsDetail);
        }());
    </script>
</dom-module>

