<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="styles/mai-shared-styles.html">

<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">

<dom-module id="mai-claimants">
    <template>

        <custom-style>
            <style include="mai-shared-styles">

            </style>
        </custom-style>

        <app-route
                route="[[route]]"
                pattern="/:page"
                data="{{claimantsData}}"
                tail="{{tailroute}}"
        ></app-route>

        <app-route
                route="{{tailroute}}"
                pattern="/claimants/detail/:recordId"
                data="{{recordIdData}}"
        ></app-route>


        <app-toolbar>
            <iron-selector class="view-toolbar" selected="[[claimantsData.page]]"  attr-for-selected="name" role="navigation">
                <a name="detail" href="[[route.prefix]]/detail">
                    <paper-fab mini icon="mai:content-copy"></paper-fab>
                    Detail view</a>
                <a name="list" href="[[route.prefix]]/list">
                    <paper-fab mini icon="mai:list"></paper-fab>
                    List view</a>
                <dom-if if="[[_shouldShowDetailHeaders]]">
                    <template>
                        <div class="detailsHeader">
                            <div># [[selectedData.fieldData.ID_claimant]]&nbsp;</div>
                            <div>[[selectedData.fieldData.Name_Full]]</div>
                            <div>&nbsp;|&nbsp;</div>
                            <div style="font-style: italic">[[selectedData.fieldData.Status]]</div>
                        </div>
                    </template>
                </dom-if>
            </iron-selector>

        </app-toolbar>
        <div>
            <iron-pages selected="[[claimantsData.page]]" attr-for-selected="name">

                <mai-claimants-list name="list" ></mai-claimants-list>
                <mai-claimants-detail id="claimantsDetailView" name="detail" recordId="{{recordIdData.recordId}}"></mai-claimants-detail>

            </iron-pages>
        </div>

    </template>

    <script>
        (function() {
            class MaiClaimants extends Polymer.Element {
                static get is() {
                    return 'mai-claimants';
                }

                static get properties(){
                    return {
                        claimantsData: {
                            type:Object,
                            notify:true,
                            observer:'_onClaimantsDataChanged'},
                        selectedData: {
                            type:Object,
                            notify:true,
                        },
                        visible: {
                            type: Boolean,
                            notify: true,
                            observer: '_onClaimantsDataChanged'
                        },
                        _shouldShowDetailHeaders : {
                            type: Boolean,
                            value: false
                        }
                    };
                }

                _onClaimantsDataChanged(claimantsData,oldClaimantsData){
                    if(this.visible) {
                        /*To check if the current view page is visible or not*/
                        if(claimantsData===true || (JSON.stringify(claimantsData) === JSON.stringify(oldClaimantsData))){
                            return;
                        }

                        if(claimantsData.page === undefined || claimantsData.page ===""){
                            this.claimantsData.page = claimantsData.page || "detail";
                            this.set('route.path',this.claimantsData.page);
                        }
                        else{
                            this._computeShouldShowDetailHeaders();
                            this.dispatchEvent(new CustomEvent('change-view',
                                {
                                    bubbles: true,
                                    composed: true,
                                    detail: {
                                        name: 'claimants',
                                        view: claimantsData.page
                                    }
                                }));

                            if(this.tailroute.path){
                                this.recordIdData.recordId = this.tailroute.path.replace("/","");
                            }
                            if(this.claimantsData.page === 'detail' && this.recordIdData.recordId !== null){
                                this.$.claimantsDetailView.recordId = this.recordIdData.recordId;
                                this.set('tailroute.path', this.recordIdData.recordId);
                                this.notifyPath('tailroute.path');
                                this.notifyPath('route.path');
                            }
                        }
                    }


                }

                ready(){
                    super.ready();
                    this.addEventListener('claimant-item-selected', e => this._onClaimantItemSelected(e));
                }

                _onClaimantItemSelected(event){
                    let detail = event.detail;
                    this.selectedData = detail.data;
                    this.recordIdData.recordId = this.selectedData.recordId;
                    this.$.claimantsDetailView.recordId = this.selectedData.recordId;
                }

                _computeShouldShowDetailHeaders(){

                    if(this.claimantsData.page==='detail'){
                        //console.log(this.claimantsData);
                        this._shouldShowDetailHeaders =  true;
                    }
                    else{
                        //console.log(this.claimantsData);
                        this._shouldShowDetailHeaders = false;
                    }

                }


            }

            window.customElements.define(MaiClaimants.is, MaiClaimants);
        }());
    </script>
</dom-module>
